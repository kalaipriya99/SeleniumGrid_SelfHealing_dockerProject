version: '3.8'

services:
  postgres-db:
    image: postgres:15-alpine
    container_name: healenium_postgres_${BUILD_NUMBER}
    environment:
      POSTGRES_DB: healenium
      POSTGRES_USER: healenium_user
      POSTGRES_PASSWORD: secret_password
    volumes:
      - db_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U healenium_user -d healenium"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - seleniumgrid_network_${BUILD_NUMBER}

  hlm-backend:
    image: healenium/hlm-backend:3.4.10
    container_name: hlm_backend_${BUILD_NUMBER}
    ports:
      - "7878:7878"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-db:5432/healenium?currentSchema=healenium
      SPRING_DATASOURCE_USERNAME: healenium_user
      SPRING_DATASOURCE_PASSWORD: secret_password
      JAVA_OPTS: "-Xmx1024m"
    depends_on:
      postgres-db:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - seleniumgrid_network_${BUILD_NUMBER}

  selector-imitator:
    image: healenium/hlm-selector-imitator:1.4
    container_name: selector_imitator_${BUILD_NUMBER}
    ports:
      - "8000:8000"
    depends_on:
      - hlm-backend
    restart: unless-stopped
    networks:
      - seleniumgrid_network_${BUILD_NUMBER}

  selenium-hub:
    image: selenium/hub:4.22.0
    container_name: selenium_hub_${BUILD_NUMBER}
    ports:
      - "4444:4444"
    environment:
      GRID_MAX_SESSION: 5
      GRID_BROWSER_TIMEOUT: 300
      GRID_TIMEOUT: 300
    restart: unless-stopped
    networks:
      - seleniumgrid_network_${BUILD_NUMBER}

  chrome-node:
    image: selenium/node-chrome:4.22.0
    container_name: chrome_node_${BUILD_NUMBER}
    depends_on:
      - selenium-hub
    environment:
      SE_EVENT_BUS_HOST: selenium-hub
      SE_EVENT_BUS_PUBLISH_PORT: 4442
      SE_EVENT_BUS_SUBSCRIBE_PORT: 4443
      SE_NODE_MAX_SESSIONS: 2
      SE_NODE_OVERRIDE_MAX_SESSIONS: true
    shm_size: 2g
    restart: unless-stopped
    networks:
      - seleniumgrid_network_${BUILD_NUMBER}

  edge-node:
    image: selenium/node-edge:4.22.0
    container_name: edge_node_${BUILD_NUMBER}
    depends_on:
      - selenium-hub
    environment:
      SE_EVENT_BUS_HOST: selenium-hub
      SE_EVENT_BUS_PUBLISH_PORT: 4442
      SE_EVENT_BUS_SUBSCRIBE_PORT: 4443
      SE_NODE_MAX_SESSIONS: 2
      SE_NODE_OVERRIDE_MAX_SESSIONS: true
    shm_size: 2g
    restart: unless-stopped
    networks:
      - seleniumgrid_network_${BUILD_NUMBER}

  selenium-tests:
    build:
      context: .
      dockerfile: Dockerfile.selenium
    container_name: selenium_tests_${BUILD_NUMBER}
    depends_on:
      - hlm-backend
      - selector-imitator
      - selenium-hub
      - chrome-node
      - edge-node
    volumes:
      - ./target:/app/target
      - ./screenshots:/app/screenshots
    environment:
      HEAL_ENABLED: "true"
      RECOVERY_TRIES: 1
      SCORE_CAP: 0.5
      HEALENIUM_BACKEND_URL: http://hlm-backend:7878
      HEALENIUM_IMITATOR_URL: http://selector-imitator:8000
      SELENIUM_REMOTE_URL: http://selenium-hub:4444/wd/hub
      MAVEN_OPTS: -Xmx512m
    entrypoint: ["/bin/bash", "/entrypoint.sh"]
    tty: true
    restart: "no"
    networks:
      - seleniumgrid_network_${BUILD_NUMBER}

volumes:
  db_data:

networks:
  seleniumgrid_network_${BUILD_NUMBER}:
    driver: bridge